
# FHIR Server Installation & Configuration

The CQL engine [client-server](client-server-guide.md) and [server-only](server-only-guide.md) modes of operation utilizes data and terminology stored in a FHIR server adhering to the FHIR R4 standard. Our testing is focused on use of the [IBM Open Source FHIR Server](https://github.com/IBM/FHIR), but any reasonably robust FHIR server, such as the [open source HAPI FHIR server](https://github.com/jamesagnew/hapi-fhir), should be usable. The configuration and management of the FHIR server is ultimately left to the user, but this guide contains some IBM FHIR configuration recommendations when using IBM FHIR for cohort evaluation. 

## IBM FHIR Server configuration steps

Collected here are notes on how to configure an IBM FHIR server to support the Alvearie cohorting common component. Many of the configuration steps, such as how to configure persistence, are left up to the solution consuming the cohorting capability, but this document describes some specific configuration that should be done if cohorting is going to be used.

### Create a tenant for storing knowledge artifacts
The measure evaluation engine relies on Measure and Library definitions that are assumed to be stored in an R4 compliant FHIR server. When using a multitenant IBM FHIR server installation, it is recommended that solutions consuming the engine configure a single, shared tenant in their FHIR server that will contain all knowledge artifacts. In our development environment, we call this tenant "knowledge". See the [IBM FHIR Server User's Guide](https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide/#322-tenant-specific-configuration-properties) for complete details on how to configure an additional tenant.

### Enable the server registry resource provider
In the fhir-server-config.json for the knowledge tenant created above, set fhirServer/core/serverRegistryResourceProviderEnabled to true to enable user-defined ValueSet stored as user-defined resources to be searchable via the REST API. This is a required setting to enable search functionality in the Measure Authoring Tool. See [the Dev Guide](/dev-guide/value-sets?id=fhir-server-setup) for complete details. The property is also described in the [IBM FHIR Server User's Guide](https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide/).

### Configure the FHIR Server's SSL certificate
IBM FHIR comes preconfigured with only an SSL endpoint enabled. A clear text HTTP endpoint can be setup, but it is *strongly recommended* not to do this for any type of production environment, especially one that processes PHI data. 

A default, well-known certificate is provided in the FHIR server installation with a subject name of localhost. The cohorting service will check the host name used to connect to the FHIR server against the certificate's subject and fail if there is no match. Users running the FHIR server on a different service from the cohorting engine code will need to [update the FHIR server's SSL certificate](https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide#52-keystores-truststores-and-the-fhir-server) and then make sure that the server's public key is trusted by the JVM that runs the cohorting component using the instructions documented in the [Getting Started](/user-guide/getting-started?id=secure-socket-layer-ssl-configuration) guide.

When running IBM FHIR on IBM Cloud it is recommended to use a certificate generated by the Kubernetes certificates API. That process is described in the [Manage TLS Certificates in a Cluster](https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/) section of the K8S user guide. Once you have a valid certificate request approved and issued in your cluster, you will need to configure  the IBM FHIR server to use that certificate and then configure the cohorting JVM to trust the server's public key. Both are typically done through Helm charts that are used to deploy the services to the IBM Cloud via a devops pipeline. Details are left up to the user, but internal teams may contact the cohorting component team for additional details on what is done within our team to meet IBM internal process guidelines.

## Configure authentication (Optional)
IBM FHIR comes preconfigured for basic authentication using a well-known username and password. While not strictly required, it is recommended that users update their FHIR server configuration to use more secure values. OAuth is also supported. See the [IBM FHIR Server User's Guide](https://ibm.github.io/FHIR/guides/FHIRServerUsersGuide/#53-openid-connect-and-oauth-20) for details on how to configure OAuth. 

## Install custom IG JARs (Optional)
If your application requires any customer Implementation Guide (IG) support such as for the [Alvearie FHIR IG](https://github.com/Alvearie/alvearie-fhir-ig) you should build and copy the appropriate JARs to your server's userlib folder as described in the [optional profile support](https://ibm.github.io/FHIR/guides/FHIRValidationGuide#optional-profile-support) instructions in the IBM FHIR Server User's Guide. 
